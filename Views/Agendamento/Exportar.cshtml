@model IEnumerable<SiteTransporteNovo.Models.Agendamento>
@{
    ViewData["Title"] = "Exportar Agendamentos";
    // Recebe as listas para os dropdowns do ViewBag
    var locaisConsulta = ViewBag.LocaisConsulta as List<string> ?? new List<string>();
    var horasUnicas = ViewBag.HorasUnicas as List<string> ?? new List<string>();

    // Recebe os valores atuais dos filtros para manter na interface
    string dataFiltroAtual = ViewBag.DataFiltro ?? "";
    string localFiltroAtual = ViewBag.LocalFiltro ?? "";
    string horaFiltroAtual = ViewBag.HoraFiltro ?? "";
}

<h2 class="mt-4 mb-4">Exportar Agendamentos</h2>

<form asp-controller="Agendamento" asp-action="Exportar" method="get" class="mb-4 row g-3">
    <div class="col-md-3">
        <label for="data" class="form-label">Data</label>
        <input type="date" name="data" id="data" class="form-control" value="@dataFiltroAtual" />
    </div>

    <div class="col-md-3">
        <label for="local" class="form-label">Local Consulta</label>
        <select name="local" id="local" class="form-select">
            <option value="">Todos</option>
            @foreach (var local in locaisConsulta)
            {
                <option value="@local" selected="@(local == localFiltroAtual ? "selected" : null)">@local</option> @* CORRIGIDO AQUI *@
            }
        </select>
    </div>

    <div class="col-md-3">
        <label for="hora" class="form-label">Hora</label>
        <select name="hora" id="hora" class="form-select">
            <option value="">Todas</option>
            @foreach (var hora in horasUnicas)
            {
                <option value="@hora" selected="@(hora == horaFiltroAtual ? "selected" : null)">@hora</option> @* CORRIGIDO AQUI *@
            }
        </select>
    </div>

    <div class="col-md-6 d-flex align-items-end gap-2">
        <button type="submit" class="btn btn-primary">Filtrar</button>
        <a asp-action="Exportar" asp-controller="Agendamento" class="btn btn-secondary">Limpar Filtros</a>
        <a asp-action="Index" asp-controller="Agendamento" class="btn btn-outline-dark ms-auto">Voltar à Lista</a>
    </div>
</form>

<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Nome</th>
            <th>Telefone</th>
            <th>Data</th>
            <th>Hora</th>
            <th>Local Consulta</th>
            <th>Local Busca</th>
            <th>Ponto Referência</th>
            <th>Motivo</th>
            <th>Acompanhante</th>
            @* Removido: <th>Responsável</th> *@
            <th>Observação</th>
            <th>Tipo de Carro</th>
        </tr>
    </thead>
    <tbody>
        @if (!Model.Any())
        {
            <tr><td colspan="11" class="text-center">Nenhum resultado encontrado.</td></tr>
        }
        else
        {
            @foreach (var item in Model)
            {
                string rowClass = "";
                if (item.TipoCarro == "Carro Prioritário")
                {
                    rowClass = "table-warning"; // amarelo
                }
                else if (item.TipoCarro == "Ambulância" || item.TipoCarro == "Ambulância com Oxigênio")
                {
                    rowClass = "table-danger"; // vermelho
                }

                bool localBuscaDestaque = !string.IsNullOrEmpty(item.LocalBusca)
                && !string.Equals(item.LocalBusca, "PS", StringComparison.OrdinalIgnoreCase)
                && !string.Equals(item.LocalBusca, "Pedra Bela", StringComparison.OrdinalIgnoreCase);

                <tr class="@rowClass text-center align-middle">
                    <td>@item.Nome</td>
                    <td>@item.Telefone</td>
                    <td>@item.Data.ToShortDateString()</td>
                    <td>@item.Hora</td>
                    <td>
                        @item.LocalConsulta
                        @if (!string.IsNullOrEmpty(item.OutroLocalConsulta))
                        {
                            <div><strong>Outro:</strong> @item.OutroLocalConsulta</div>
                        }
                    </td>
                    <td class="@(localBuscaDestaque ? "text-danger fw-bold" : "")">
                        @item.LocalBusca
                        @if (!string.IsNullOrEmpty(item.OutroLocalBusca))
                        {
                            <div><strong>Outro:</strong> @item.OutroLocalBusca</div>
                        }
                    </td>
                    <td>@item.PontoReferencia</td>
                    <td>@item.Motivo</td>
                    <td>@(item.PrecisaAcompanhante ? "Sim" : "Não")</td>
                    @* Removido: <td>@item.Responsavel</td> *@
                    <td>@item.Observacao</td>
                    <td>
                        @if (item.TipoCarro == "Outro")
                        {
                            @item.TipoCarroOutro
                        }
                        else
                        {
                            @item.TipoCarro
                        }
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<style>
    .table-warning {
        background-color: #ffc107; /* Bootstrap yellow */
    }

    .table-danger {
        background-color: #dc3545; /* Bootstrap red */
        color: #fff; /* White text on red for better contrast */
    }

    .text-danger {
        color: #dc3545 !important;
    }

    .fw-bold {
        font-weight: bold !important;
    }
</style>