@model IEnumerable<SiteTransporteNovo.Models.Agendamento>
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Visualizar Agendamentos";
    var tipoUsuario = ViewBag.TipoUsuario?.ToString() ?? "";
    
    // Extrair os locais únicos de consulta para o filtro dropdown (ordenado alfabeticamente)
    var locaisConsulta = Model
        .Select(a => a.LocalConsulta)
        .Distinct()
        .OrderBy(l => l)
        .ToList();
    
    // Opcionalmente, incluir "Outros" no final se precisar
    if (!locaisConsulta.Contains("Outros"))
    {
        locaisConsulta.Add("Outros");
    }
}

<h2 class="text-center my-4">Visualizar Agendamentos</h2>

<!-- Formulário de Filtro -->
<form method="get" class="row row-cols-auto g-3 align-items-end mb-4">
    <div class="col">
        <label for="buscaData" class="form-label">Data</label>
        <input type="date" name="buscaData" id="buscaData" class="form-control" value="@Context.Request.Query["buscaData"]" />
    </div>
    <div class="col">
        <label for="buscaHora" class="form-label">Hora</label>
        <input type="time" name="buscaHora" id="buscaHora" class="form-control" value="@Context.Request.Query["buscaHora"]" />
    </div>
    <div class="col">
        <label for="buscaLocal" class="form-label">Local Consulta</label>
        <select name="buscaLocal" id="buscaLocal" class="form-select">
            <option value="">Todos</option>
            @foreach (var local in locaisConsulta)
            {
                var selected = Context.Request.Query["buscaLocal"] == local ? "selected" : "";
                <option value="@local" selected="@(Context.Request.Query["buscalocal"] == local ? "selected" : null)">@local</option>




            }
        </select>
    </div>
    <div class="col">
        <label for="buscaLocalBusca" class="form-label">Local Busca</label>
        <input type="text" name="buscaLocalBusca" id="buscaLocalBusca" class="form-control" placeholder="Local para ir buscar" value="@Context.Request.Query["buscaLocalBusca"]" />
    </div>
    <div class="col">
        <label for="buscaNome" class="form-label">Nome Paciente</label>
        <input type="text" name="buscaNome" id="buscaNome" class="form-control" placeholder="Nome do paciente" value="@Context.Request.Query["buscaNome"]" />
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-primary">Filtrar</button>
        <a href="@Url.Action("Index")" class="btn btn-secondary ms-2">Limpar Filtros</a>
    </div>
</form>

<!-- Botões de ação -->
<div class="mb-3">
    <a class="btn btn-secondary me-2" asp-action="ImprimirAgendamentos"
       asp-route-buscaData="@Context.Request.Query["buscaData"]"
       asp-route-buscaHora="@Context.Request.Query["buscaHora"]"
       asp-route-buscaLocal="@Context.Request.Query["buscaLocal"]"
       asp-route-buscaNome="@Context.Request.Query["buscaNome"]"
       asp-route-buscaLocalBusca="@Context.Request.Query["buscaLocalBusca"]"
       target="_blank">Imprimir</a>
    <a asp-controller="Menu" asp-action="Index" class="btn btn-primary me-2">Voltar ao Menu</a>
</div>

<!-- Tabela -->
<div id="areaTabela" style="overflow-x:auto;">
    <table class="table table-bordered table-striped w-100">
        <thead class="table-dark text-center align-middle">
            <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Data</th>
                <th>Hora</th>
                <th>Local Consulta</th>
                <th>Local Busca</th>
                <th>Ponto Referência</th>
                <th>Motivo</th>
                <th>Acompanhante</th>
                <th>Responsável</th>
                <th>Observação</th>
                <th>Tipo de Carro</th>
                @if (tipoUsuario == "Admin")
                {
                    <th class="text-center">Ações</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                string rowClass = "";
                if (item.TipoCarro == "Carro Prioritário")
                {
                    rowClass = "table-warning"; // amarelo
                }
                else if (item.TipoCarro == "Ambulância" || item.TipoCarro == "Ambulância com Oxigênio")
                {
                    rowClass = "table-danger"; // vermelho
                }

                // Local de busca fica vermelho e em negrito se diferente de "PS" e "Pedra Bela"
                bool localBuscaDestaque = !string.IsNullOrEmpty(item.LocalBusca)
                                         && !string.Equals(item.LocalBusca, "PS", StringComparison.OrdinalIgnoreCase)
                                         && !string.Equals(item.LocalBusca, "Pedra Bela", StringComparison.OrdinalIgnoreCase);

                <tr class="@rowClass text-center align-middle">
                    <td>@item.Nome</td>
                    <td>@item.Telefone</td>
                    <td>@item.Data.ToShortDateString()</td>
                    <td>@item.Hora</td>
                    <td>
                        @item.LocalConsulta
                        @if (!string.IsNullOrEmpty(item.OutroLocalConsulta))
                        {
                            <div><strong>Outro:</strong> @item.OutroLocalConsulta</div>
                        }
                    </td>
                    <td class="@(localBuscaDestaque ? "text-danger fw-bold" : "")">
                        @item.LocalBusca
                        @if (!string.IsNullOrEmpty(item.OutroLocalBusca))
                        {
                            <div><strong>Outro:</strong> @item.OutroLocalBusca</div>
                        }
                    </td>
                    <td>@item.PontoReferencia</td>
                    <td>@item.Motivo</td>
                    <td>@(item.PrecisaAcompanhante ? "Sim" : "Não")</td>
                    <td>@item.Responsavel</td>
                    <td>@item.Observacao</td>
                    <td>
                        @if (item.TipoCarro == "Outro")
                        {
                            @item.TipoCarroOutro
                        }
                        else
                        {
                            @item.TipoCarro
                        }
                    </td>
                    @if (tipoUsuario == "Admin")
                    {
                        <td class="text-center">
                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning me-1">Editar</a>
                            <a asp-action="Cancelar" asp-route-id="@item.Id" class="btn btn-sm btn-danger" onclick="return confirm('Tem certeza que deseja cancelar este agendamento?');">Cancelar</a>
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

<style>
    body {
        overflow-x: hidden;
    }

    table {
        width: 100%;
        font-size: 14px;
    }

    .text-danger {
        color: #dc3545 !important;
    }

    .fw-bold {
        font-weight: bold !important;
    }
</style>
